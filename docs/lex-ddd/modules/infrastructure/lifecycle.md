# 生命周期管理模块

## 模块介绍

生命周期管理模块(`lifecycle.py`)是基础设施层的核心组件，负责管理应用程序的启动、运行和关闭等生命周期事件。该模块确保系统组件能够按照正确的顺序初始化和清理。

## 功能特性

- 应用启动初始化
- 优雅关闭处理
- 资源管理
- 依赖注入支持
- 事件监听机制

## 配置说明

生命周期相关配置项在`.env`文件中定义：

```env
# 应用生命周期配置
SHUTDOWN_TIMEOUT=30
STARTUP_TIMEOUT=60
HEALTH_CHECK_INTERVAL=15
```

## 使用示例

### 注册启动事件

```python
from infrastructure.lifecycle import on_startup

@on_startup
async def initialize_database():
    # 数据库初始化逻辑
    await setup_database_connection()
    await run_migrations()
```

### 注册关闭事件

```python
from infrastructure.lifecycle import on_shutdown

@on_shutdown
async def cleanup_resources():
    # 资源清理逻辑
    await close_database_connections()
    await cancel_background_tasks()
```

## AI提示词使用技巧

### 1. 添加生命周期事件

提示词模板：
```
请帮我添加以下生命周期事件：
1. 事件类型：[启动/关闭]
2. 执行顺序：[优先级]
3. 处理逻辑：[具体操作]
4. 超时设置：[超时时间]
5. 错误处理：[处理方式]
```

示例：
```
请帮我添加以下生命周期事件：
1. 事件类型：启动事件
2. 执行顺序：最高优先级
3. 处理逻辑：初始化数据库连接池
4. 超时设置：30秒
5. 错误处理：重试3次，失败则终止启动
```

### 2. 资源管理配置

提示词模板：
```
请帮我配置资源管理策略：
1. 资源类型：[资源名称]
2. 初始化时机：[时间点]
3. 清理策略：[清理方式]
4. 监控指标：[监控项]
5. 告警阈值：[阈值设置]
```

### 3. 依赖注入设置

提示词模板：
```
请帮我设置依赖注入：
1. 服务名称：[服务名]
2. 注入范围：[作用域]
3. 初始化参数：[参数列表]
4. 生命周期：[实例生命周期]
5. 懒加载：[是/否]
```

## 最佳实践

1. 合理安排启动顺序
2. 实现优雅关闭
3. 设置适当超时
4. 添加健康检查
5. 完善错误处理

## 常见问题

1. **启动超时**
   - 原因：初始化耗时过长
   - 解决：优化启动流程或调整超时时间

2. **资源未释放**
   - 原因：关闭处理不完整
   - 解决：确保所有资源都有对应的清理逻辑

3. **依赖循环**
   - 原因：服务间相互依赖
   - 解决：重新设计依赖关系

## 注意事项

1. 避免启动逻辑过重
2. 确保关闭顺序正确
3. 处理异常情况
4. 添加必要的日志
5. 实现健康检查机制